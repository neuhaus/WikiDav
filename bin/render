#!/bin/bash

source "$(dirname "$(readlink -f "$BASH_SOURCE")")/common"

test $# -eq 1 || exit 1
faras "$1" && test "${1##*.}" == "txt" || exit 1
htmlfile="$HTML_DIR${1#$EDIT_DIR}"
corexml="${htmlfile%.txt}-a.xml"
htmlfile="${htmlfile%.txt}.html"
title="$(grep "^==*$" -B 1 "$1" | head -n 1)"
if [ -z "$title" ]; then # try the other h1 style
	title="$(sed -r 's/^#([^#]*)#*$/\1/;T crap;s/^\s*|\s*$//g;q;:crap;d' "$1")"
fi
if [ -z "$title" ]; then
	title="$(basename "$htmlfile" .html)"
fi

cat > "$corexml.$$" <<.
<article>$(markdown "$1")</article>
.
chmod a+r "$corexml.$$"
mv "$corexml.$$" "$corexml"
template "$1" "$title" > "$htmlfile.$$"
log "rendering $1 into $htmlfile"
chmod a+r "$htmlfile.$$"
mv "$htmlfile.$$" "$htmlfile"
