#!/bin/bash

if [ -z "$HTML_DIR" ]; then
	source "$(dirname "$(readlink -f "$BASH_SOURCE")")/common"
fi

test $# -eq 1 || exit 1
faras "$1" && test "${1##*.}" == "txt" || exit 1
htmlfile="$HTML_DIR${1#$EDIT_DIR}"
htmlfile="${htmlfile%.txt}.html"

log "rendering $1 into $htmlfile"
cat > "$htmlfile.$$" <<.
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>$(grep "^==*$" -B 1 "$1" | head -n 1) - WikiDav</title>
<link href="http://zash.se/css/sass/master.css" rel="stylesheet" type="text/css">
</head>
<body class="with-bg">
<div id="rootcontainer">
<header><hgroup><h1 class="zashlogo"><span>Zash.se</span></h1><h2>Wiki</h2></hgroup></header>
<div class="wiki-page" id="content"><article>$(markdown "$1")</article></div>
</div>
</body>
</html>
.
chmod a+r "$htmlfile.$$"
mv "$htmlfile.$$" "$htmlfile"
